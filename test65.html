<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>A-Frame Cursor Teleport Component - Basic</title>
    <meta name="description" content="Basic example for Cursor Teleport component."></meta>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-cursor-teleport@1.5.0/dist/aframe-cursor-teleport-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-blink-controls/dist/aframe-blink-controls.min.js"></script>
  </head>
  <body>
    <script>
      let modelAdded = [false, false, false];
      let imageAdded = [false, false, false];

      function spawnModelImage(i, finalScaleModel, finalPositionImage, finalScaleImage, imageUrl) {
          const existingModel = document.querySelector(`.spawned-model${i}`);
          const existingImage = document.querySelector(`.spawned-image${i}`);
          const existingImageInv = document.querySelector(`.spawned-imageInv${i}`);
          const existingBox = document.querySelector(`.spawned-box${i}`);

          if (!modelAdded[i] && !imageAdded[i]) {
              // モデルを追加
              spawnModel(i, finalScaleModel);
              modelAdded[i] = true;
          } else if (modelAdded[i] && !imageAdded[i]) {
              // 画像を追加
              spawnImage(i, finalPositionImage, finalScaleImage, imageUrl);
              imageAdded[i] = true;
          } else {
              // モデルと画像を削除
              if (existingModel) {
                  existingModel.parentNode.removeChild(existingModel);
              }
              if (existingImage) {
                  existingImage.parentNode.removeChild(existingImage);
              }
              modelAdded[i] = false;
              imageAdded[i] = false;
          }
      }

      function spawnImage(i, finalPosition, finalScale, imageUrl) {
          const existingImage = document.querySelector(`.spawned-image${i}`);
          if (existingImage) {
              existingImage.parentNode.removeChild(existingImage);
              return;
          }

          // 親要素を作成
          const parentEntity = document.createElement('a-entity');
          
          // 画像を作成
          const image = document.createElement('a-image');
          image.classList.add(`spawned-image${i}`);
          image.setAttribute('src', imageUrl);
          image.setAttribute('rotation', '0 0 0');
          image.setAttribute('animation__position', `property: position; to: ${finalPosition.x} ${finalPosition.y} ${finalPosition.z}; dur: 2000; easing: easeInOutQuad`);
          image.setAttribute('animation__scale', `property: scale; to: ${finalScale.x} ${finalScale.y} ${finalScale.z}; dur: 2000; easing: easeInOutQuad`);

          // 親子関係を設定
          parentEntity.appendChild(image);

          // 画像を追加する場所を決定
          const clickableElements = document.querySelectorAll('.clickable');
          if (clickableElements[i - 1]) {
              clickableElements[i - 1].appendChild(parentEntity);
          } else {
              console.error('Clickable element not found for image');
          }
      }

      function spawnModel(i, finalScale) {
        const model = document.createElement('a-entity');
        model.classList.add(`spawned-model${i}`);
        model.setAttribute('gltf-model', `#model-asset${i}`);
        model.setAttribute('animation__position', 'property: position; to: 0 2.5 0; dur: 2000; easing: easeInOutQuad');
        model.setAttribute('scale', '0 0 0');
        model.setAttribute('animation__scale', `property: scale; to: ${finalScale.x} ${finalScale.y} ${finalScale.z}; dur: 2000; easing: easeInOutQuad`);
        model.setAttribute('animation__rotation', 'property: rotation; to: 0 360 0; loop: true; dur: 20000; easing: linear');

        const clickableElements = document.querySelectorAll('.clickable');
        if (clickableElements[i - 1]) {
          clickableElements[i - 1].appendChild(model);
        } else {
          console.error('Clickable element not found for model');
        }
      }

      AFRAME.registerComponent('spawn-sphere1', {
        init: function () {
          this.el.addEventListener('click', () => {
            spawnModelImage(1, { x: 3, y: 3, z: 3 }, { x: 0 * 20, y: 1.5 * 20, z: -2.5 * 20 }, { x: 3 * 20, y: 1.5 * 20, z: 0 }, "https://echizencity.github.io/opendata/kokufuhakkutsu/20100_kokufuhakkutsu.png");
          });
        }
      });

      AFRAME.registerComponent('spawn-sphere2', {
        init: function () {
          this.el.addEventListener('click', () => {
            spawnModelImage(2, { x: 3, y: 3, z: 3 }, { x: 0 * 20, y: 1.5 * 20, z: -2.5 * 20 }, { x: 3 * 20, y: 1.5 * 20, z: 0 }, "https://echizencity.github.io/opendata/kokufuhakkutsu/20200_kokufuhakkutsu.png");
          });
        }
      });

      AFRAME.registerComponent('spawn-sphere3', {
        init: function () {
          this.el.addEventListener('click', () => {
            spawnModelImage(3, { x: 3, y: 3, z: 3 }, { x: 0 * 20, y: 1.5 * 20, z: -2.5 * 20 }, { x: 3 * 20, y: 1.5 * 20, z: 0 }, "https://echizencity.github.io/opendata/kokufuhakkutsu/20300_kokufuhakkutsu.png");
          });
        }
      });
    </script>

    <a-scene cursor="rayOrigin: mouse" raycaster="objects: .clickable" renderer="colorManagement: false;">
      <!-- ui element -->
      <a-entity class="clickable" spawn-sphere1 geometry="primitive: sphere" scale=".05 .05 .05" position="-3 1.2 0" material="color: white"></a-entity>
      <a-entity class="clickable" spawn-sphere2 geometry="primitive: sphere" scale=".05 .05 .05" position="0 1.2 -1.5" material="color: white"></a-entity>
      <a-entity class="clickable" spawn-sphere3 geometry="primitive: sphere" scale=".05 .05 .05" position="3 1.2 1.5" material="color: white"></a-entity>

      <a-entity gltf-model="#kokufu" scale="1 1 1" position="0 -0.5 0" rotation="0 20 0"></a-entity>
      <a-entity class="collision" position="0 0 0" rotation="-90 0 0" geometry="primitive: plane; width: 18; height: 8" material="color: white; opacity: 0."></a-entity>

      <a-entity id="destination1" position="3 0 3" rotation="0 0 0"></a-entity>
      <a-entity id="moveup1" class="clickable" geometry="primitive: plane; width: 0.9; height: 0.3" text="value: move directly\non 1st platform; align: center; width: 2" position="0 2 -3.5" rotation="0 0 0" material="color: #000000"></a-entity>
      <a-entity id="destination2" position="8 0 -2.5" rotation="0 135 0"></a-entity>
      <a-entity id="moveup2" class="clickable" geometry="primitive: plane; width: 0.9; height: 0.3" text="value: move directly\non 2nd platform; align: center; width: 2" position="5 2 -3.5" rotation="0 -15 0" material="color: #000000"></a-entity>
      <a-entity id="destination3" position="-8 0 -2.5" rotation="0 -135 0"></a-entity>
      <a-entity id="moveup3" class="clickable" geometry="primitive: plane; width: 0.9; height: 0.3" text="value: move directly\non 3rd platform; align: center; width: 2" position="4 2 3.5" rotation="0 135 0" material="color: #000000"></a-entity>
      <a-entity id="destination4" position="0 0 0" rotation="0 0 0"></a-entity>
      <a-entity id="moveup4" class="clickable" geometry="primitive: plane; width: 0.9; height: 0.3" text="value: return directly\non start platform; align: center; width: 2" position="-4 2 3.5" rotation="0 225 0" material="color: #000000"></a-entity>

      <!-- scene geometry -->
      <a-assets>
        <a-asset-item id="kokufu" src="https://www.city.echizen.lg.jp/office/030/021/open-data-echizen_d/fil/00101_kokufuhakkutsu.glb"></a-asset-item>
        <a-asset-item id="model-asset1" src="https://code4fukui.github.io/vr-dinosaur-museum/arrow.glb"></a-asset-item>
        <a-asset-item id="model-asset2" src="https://code4fukui.github.io/vr-dinosaur-museum/arrow.glb"></a-asset-item>
        <a-asset-item id="model-asset3" src="https://code4fukui.github.io/vr-dinosaur-museum/arrow.glb"></a-asset-item>
      </a-assets>

      <!-- player -->
      <a-entity id="cameraRig" position="0 0 0" cursor-teleport="cameraRig: #cameraRig; cameraHead: #head; collisionEntities: .collision; ignoreEntities: .clickable">
        <a-entity id="head" position="0 1.52 0" camera look-controls="reverseMouseDrag: true"></a-entity>
        <a-entity
          laser-controls="hand: left"
          raycaster="objects: .clickable; far: 100"
          line="color: red; opacity: 0.75"
          blink-controls="
            collisionEntities: .collision;
            cameraRig: #cameraRig;
            teleportOrigin: #head;
            curveShootingSpeed: 6"></a-entity>
        <a-entity
          laser-controls="hand: right"
          raycaster="objects: .clickable"
          line="color: red; opacity: 0.75"
          blink-controls="
            collisionEntities: .collision;
            cameraRig: #cameraRig;
            teleportOrigin: #head;
            curveShootingSpeed: 6"></a-entity>
      </a-entity>
    </a-scene>

    <script>
      const cameraRig = document.getElementById('cameraRig');

      for (let i = 1; i <= 4; i++) {
        const moveup = document.getElementById(`moveup${i}`);
        const destination = document.getElementById(`destination${i}`);
        moveup.addEventListener('click', () => {
          const cursorTeleport = cameraRig.components['cursor-teleport'];
          cursorTeleport.teleportTo(destination.object3D.position, destination.object3D.quaternion);
        });
      }
    </script>

  </body>
</html>
