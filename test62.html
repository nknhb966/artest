<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>越前国府発掘プロジェクトVR</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script> <!-- VRとARでバージョン異なる -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-cursor-teleport@1.5.0/dist/aframe-cursor-teleport-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-blink-controls/dist/aframe-blink-controls.min.js"></script> <!-- VRとARで異なる -->
  </head>
  <script>
      var velocity = {x: 0, y: 0, z: 0};
      var acceleration = 0.004;
      var deceleration = 0.002;
      var maxVelocity = 0.008;
      var shouldStop = true;

      AFRAME.registerComponent('thumbstick-logging', {
        init: function () {
          this.el.addEventListener('thumbstickmoved', this.logThumbstick);
        },

        logThumbstick: function (event) {
          if (event.detail.x == 0) {
            velocity.x = 0;
            shouldStop = true;
          } else if (event.detail.x > 0.9) {
            velocity.x -= acceleration;
            shouldStop = false;
          } else if (event.detail.x < -0.9) {
            velocity.x += acceleration;
            shouldStop = false;
          }
          if (event.detail.y == 0) {
            velocity.z = 0;
            shouldStop = true;
          } else if (event.detail.y > 0.9) {
            velocity.z -= acceleration;
            shouldStop = false;
          } else if (event.detail.y < -0.9) {
            velocity.z += acceleration;
            shouldStop = false;
          }
        }
      });

      function updateModelMovement() {
        var model = document.getElementById('modelContainer');
        var currentPosition = model.getAttribute('position');
      
        if (shouldStop) {
          velocity = {x: 0, y: 0, z: 0};
          model.setAttribute('position', currentPosition);
          return;
        }
      
        // 速度の減衰、最大速度の制御など
        if (velocity.x > 0) {
          velocity.x -= deceleration;
          if (velocity.x < deceleration) {
            velocity.x = 0;
          }
        }
        if (velocity.x < 0) {
          velocity.x += deceleration;
          if (velocity.x > -deceleration) {
            velocity.x = 0;
          }
        }
        if (velocity.z > 0) {
          velocity.z -= deceleration;
          if (velocity.z < deceleration) {
            velocity.z = 0;
          }
        }
        if (velocity.z < 0) {
          velocity.z += deceleration;
          if (velocity.z > -deceleration) {
            velocity.z = 0;
          }
        }
        
        // 速度が最大速度を超えないように制御
        var speed = Math.sqrt(velocity.x * velocity.x + velocity.z * velocity.z);
        if (speed > maxVelocity) {
          var ratio = maxVelocity / speed;
          velocity.x *= ratio;
          velocity.z *= ratio;
        }
      
        // 位置の更新
        model.setAttribute('position', {
          x: currentPosition.x + velocity.x,
          y: currentPosition.y + velocity.y,
          z: currentPosition.z + velocity.z
        });

        // 速度の表示を更新
        var velocityText = document.getElementById('velocityText');
        velocityText.setAttribute('text', 'value', 'Velocity: ' + velocity.x.toFixed(4) + ', ' + velocity.y.toFixed(4) + ', ' + velocity.z.toFixed(4));
      }

      // フレームごとにモデルの移動を更新
      AFRAME.registerComponent('move-model', {
        tick: function () {
          updateModelMovement();
        }
      });
  </script>

  <body>
    <a-scene cursor="rayOrigin: mouse" raycaster="objects: .clickable" renderer="colorManagement: true;">

      <!-- scene geometry -->
      <a-assets>
        <a-asset-item id="kokufu" src="https://www.city.echizen.lg.jp/office/030/021/open-data-echizen_d/fil/00101_kokufuhakkutsu.glb"></a-asset-item> <!-- VRはオリジナル版を使用 -->
      </a-assets>
      
      <a-entity id="velocityText" position="0 1.5 -3" text="value: Velocity: 0, 0, 0; color: white;"></a-entity>

      <!-- モデルをmodelContainerに格納 -->
      <a-entity id="modelContainer" position="0 0 0" move-model>

<!--         <a-entity gltf-model="#kokufu" scale="1 1 1" position="0 -0.5 0" rotation="0 20 0"></a-entity> -->
        <a-entity gltf-model="#kokufu" scale="1 1 1" position="0 -0.5 0" rotation="0 20 0" class="model" collidable></a-entity>

        <!-- VRのみ設定（テレポート系） -->
        <a-entity class="collision" position="0 0 0" rotation="-90 0 0" geometry="primitive: plane; width: 18; height: 8" material="color: aqua; opacity: 0."></a-entity>

        <!-- VRのみ設定（上部概要） -->
        <a-entity id="panel1" position="4 3.5 0.5">
          <a-image src="https://echizencity.github.io/opendata/kokufuhakkutsu/20000_kokufuhakkutsu.png" scale="4 5 0" rotation="70 -90 0"></a-image>
        </a-entity>
        <a-entity id="panel2" position="-4 3.5 0.5">
          <a-image src="https://echizencity.github.io/opendata/kokufuhakkutsu/20000_kokufuhakkutsu.png" scale="4 5 0" rotation="70 90 0"></a-image>
        </a-entity>
      </a-entity>
    </a-scene>
  </body>
</html>
