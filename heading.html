<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>

    <script type="text/javascript">
        let os;

        window.addEventListener("DOMContentLoaded", init);

        function init() {
            os = detectOSSimply();
            if (os === "iphone") {
                document.querySelector("#permit").addEventListener("click", permitDeviceOrientationForSafari);
                window.addEventListener("deviceorientation", orientation, true);
            } else if (os === "android") {
                window.addEventListener("deviceorientationabsolute", orientation, true);
            } else {
                window.alert("PC未対応サンプル");
            }
        }

        function orientation(event) {
            let degrees;
            if (os === "iphone") {
                degrees = event.webkitCompassHeading;
            } else {
                degrees = event.alpha;
            }

            let direction;
            if ((degrees > 337.5 && degrees < 360) || (degrees > 0 && degrees < 22.5)) {
                direction = "北";
            } else if (degrees > 22.5 && degrees < 67.5) {
                direction = "北東";
            } else if (degrees > 67.5 && degrees < 112.5) {
                direction = "東";
            } else if (degrees > 112.5 && degrees < 157.5) {
                direction = "東南";
            } else if (degrees > 157.5 && degrees < 202.5) {
                direction = "南";
            } else if (degrees > 202.5 && degrees < 247.5) {
                direction = "南西";
            } else if (degrees > 247.5 && degrees < 292.5) {
                direction = "西";
            } else if (degrees > 292.5 && degrees < 337.5) {
                direction = "北西";
            }

            document.querySelector("#direction").innerHTML = direction + " : " + degrees;
        }

        function detectOSSimply() {
            if (navigator.userAgent.match(/iPhone|iPod|iPad/i)) {
                return "iphone";
            } else if (navigator.userAgent.match(/Android/i)) {
                return "android";
            } else {
                return "pc";
            }
        }

        function permitDeviceOrientationForSafari() {
            DeviceOrientationEvent.requestPermission()
                .then(response => {
                    if (response === "granted") {
                        window.addEventListener("deviceorientation", orientation);
                    }
                })
                .catch(console.error);
        }
    </script>
</head>
<body>
    <ul>
        <input type="button" id="permit" value="SafariでDeviceOrientationを許可"/>
        <li>【方角】<span id="direction"></span></li>
    </ul>
</body>
</html>
