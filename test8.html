<html>
  <head>
    <title>JoystickTest</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/aframe-v1.2.0/aframe/build/aframe-ar.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      #joystick {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10;
      }
      #joystick-frame {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 2px white solid;
        position: relative;
      }
      #joystick-ball {
        width: 40px;
        height: 40px;
        background: white;
        border-radius: 50%;
        border: 2px white solid;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
    </style>
  </head>
  <body>
    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
    >
      <a-assets>
        <a-asset-item id="test" src="https://www.city.echizen.lg.jp/office/030/021/open-data-echizen_d/fil/00101_kokufuhakkutsu.glb"></a-asset-item>
      </a-assets>
      <a-entity id="model" gps-entity-place="latitude: 35.921673519415656; longitude: 136.1852468827077;">
        <a-entity
          gltf-model="#test"
          scale="1 1 1"
          position="0 -0.5 0"
          rotation="0 0 0"
        ></a-entity>
      </a-entity>
      <a-camera gps-camera rotation-reader></a-camera>
      <div id="joystick" class="joystick">
        <div id="joystick-frame" class="joystick-frame">
          <div id="joystick-ball" class="joystick-ball"></div>
        </div>
      </div>
    </a-scene>
    <script>
      let joystickBall;
      let joystickCenterX;
      let joystickCenterY;
      let joystickLimitNumber = 35;

      const init = () => {
        setupJoystick();
      };

      const setupJoystick = () => {
        joystickBall = document.getElementById("joystick-ball");
        joystickCenterX =
          joystickBall.getBoundingClientRect().left + joystickBall.clientWidth / 2;
        joystickCenterY =
          joystickBall.getBoundingClientRect().top + joystickBall.clientHeight / 2;

        joystickBall.addEventListener("touchstart", dragStart);
        joystickBall.addEventListener("touchmove", dragMove);
        joystickBall.addEventListener("touchend", dragEnd);

        joystickBall.onmousedown = dragStart;
        document.onmouseup = dragEnd;
      };

      const dragStart = (event) => {
        event.preventDefault();
        if (event.type === "mousedown") {
          document.onmousemove = dragMove;
          document.onmouseup = dragEnd;
        }

        joystickBall.classList.add("active");
      };

      const dragMove = (event) => {
        event.preventDefault();

        let clientX, clientY;

        if (event.type === "touchmove") {
          clientX = event.touches[0].clientX;
          clientY = event.touches[0].clientY;
        } else {
          clientX = event.clientX;
          clientY = event.clientY;
        }

        let touchX = clientX - joystickCenterX;
        let touchY = clientY - joystickCenterY;

        if (Math.abs(touchX) > Math.abs(touchY)) {
          touchY = 0;
        } else {
          touchX = 0;
        }

        touchX = Math.max(-joystickLimitNumber, Math.min(joystickLimitNumber, touchX));
        touchY = Math.max(-joystickLimitNumber, Math.min(joystickLimitNumber, touchY));

        joystickBall.style.left = `calc(50% + ${touchX}px)`;
        joystickBall.style.top = `calc(50% + ${touchY}px)`;

        // 3Dモデルの移動
        const model = document.getElementById("model");
        model.object3D.position.x += touchX * 0.01; // 左右移動
        model.object3D.position.z += touchY * 0.01; // 上下移動
      };

      const dragEnd = () => {
        joystickBall.classList.remove("active");
        joystickBall.style.top = "50%";
        joystickBall.style.left = "50%";

        document.onmousemove = null;
      };

      init();

      window.addEventListener("resize", () => {
        joystickCenterX =
          joystickBall.getBoundingClientRect().left + joystickBall.clientWidth / 2;
        joystickCenterY =
          joystickBall.getBoundingClientRect().top + joystickBall.clientHeight / 2;
      });
    </script>
  </body>
</html>
