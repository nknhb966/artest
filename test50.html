<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ロケーションベースTest7</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        font-weight: bold;
        overflow: hidden;
      }
      #rotateMessage {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 24px;
        z-index: 9999;
      }
      #contentWrapper {
        display: none;
      }
      #compassHeadingDisplay {
        position: fixed;
        top: 50px;
        left: 10px;
        z-index: 99999;
        color: white;
      }
      #dropdownContainer {
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 99999;
      }
      .reload-button {
        position: fixed;
        font-family: Arial, sans-serif;
        padding: 8px;
        font-size: 16px;
        top: 10px;
        right: 10px;
        z-index: 1000;
      }
    </style>
  </head>

  <body>
    <div id="rotateMessage">Rotate Your Phone</div>
    <div id="contentWrapper">
    <div id="dropdownContainer"></div>
    <button class="reload-button" onclick="location.reload()">aReload</button>
    <div id="compassHeadingDisplay">
        <span id="direction"></span>
    </div>

    <a-scene embedded arjs vr-mode-ui="enabled: false">
      <a-assets>
        <a-asset-item id="test" src="https://www.city.echizen.lg.jp/office/030/021/open-data-echizen_d/fil/00101_kokufuhakkutsu.glb" scale="1 1 1"></a-asset-item>
      </a-assets>
        <a-entity id="model" gltf-model="#test" position="0 0 0" rotation="0 0 0"></a-entity>
      <a-entity camera></a-entity>
    </a-scene>

    </div>

    <script>
      // ピンチ操作の初期値を設定
      var initialDistance = 0;
      var initialAngle = 0;
      var touchStartX = 0;
      var touchStartY = 0;
  
      const init = () => {
        // Touch events
        var lastTouchEnd = 0;
        document.addEventListener('touchstart', onTouchStart, { passive: false });
        document.addEventListener('touchmove', onTouchMove, { passive: false });
        document.addEventListener('touchend', function (event) {
            var now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
      };

      function onTouchStart(event) {
          if (event.touches.length == 1) {
              touchStartX = event.touches[0].clientX;
              touchStartY = event.touches[0].clientY;
          }
          else if (event.touches.length == 2) {
              var touch1 = event.touches[0];
              var touch2 = event.touches[1];
              initialDistance = Math.hypot(touch1.clientX - touch2.clientX, touch1.clientY - touch2.clientY);
              initialAngle = Math.atan2(touch2.clientY - touch1.clientY, touch2.clientX - touch1.clientX) * 180 / Math.PI;
          }
      }

      const pinchThreshold = 10;

      function onTouchMove(event) {
              var model = document.getElementById(`model`);

              if (event.touches.length == 1) {
                  event.preventDefault();
                  
                  var touchX = event.touches[0].clientX;
                  var touchY = event.touches[0].clientY;

                  var deltaX = touchX - touchStartX;
                  var deltaY = touchY - touchStartY;

                  let rad = 0;
                  if(os == "iphone") {
                    rad = degrees * Math.PI / 180;
                  }else{
                    rad = (degrees + orientation) * Math.PI / 180;
                  }        
                  const newX = deltaX * Math.cos(rad) - deltaY * Math.sin(rad);
                  const newY = deltaX * Math.sin(rad) + deltaY * Math.cos(rad);

                  model.object3D.position.x += newX * 0.005;
                  model.object3D.position.z += newY * 0.005;

                  touchStartX = touchX;
                  touchStartY = touchY;
              }
              else if (event.touches.length == 2) {
                  event.preventDefault();

                  var touch1 = event.touches[0];
                  var touch2 = event.touches[1];
                  var currentDistance = Math.hypot(touch1.clientX - touch2.clientX, touch1.clientY - touch2.clientY);
                  var distanceDiff = currentDistance - initialDistance;
                  var currentAngle = Math.atan2(touch2.clientY - touch1.clientY, touch2.clientX - touch1.clientX) * 180 / Math.PI;

                  if (currentDistance - pinchThreshold > initialDistance) {
                      model.object3D.position.y += 0.3;
                  } else if (currentDistance + pinchThreshold < initialDistance) {
                      model.object3D.position.y -= 0.3;
                  }

                  var angleChange = currentAngle - initialAngle;
                  model.object3D.rotation.y -= angleChange * Math.PI / 180 * 1;

                  initialDistance = currentDistance;
                  initialAngle = currentAngle;
              }
          }

      // OS識別用
      let os;

      // イベントリスナーを定義
      window.addEventListener("deviceorientation", handleOrientation, true);
      window.addEventListener("deviceorientationabsolute", handleOrientation, true);

      // DOM構築完了イベントハンドラ登録
      window.addEventListener("DOMContentLoaded", initOS);

      // 初期化
      function initOS() {
          os = detectOSSimply();
          if (os == "iphone") {
              permitDeviceOrientationForSafari();
          }
      }
  
      let degrees = 0;
      let orientation = 0;

      function handleOrientation(event) {
        let alpha = event.alpha;
        if(os == "iphone") {
          degrees = event.webkitCompassHeading;
        }else{
          degrees = compassHeading(alpha);
        }
        if(window.orientation !== undefined) {
            orientation = window.orientation;
        }
        else {
            orientation = 0;
        }
        document.querySelector("#direction").innerHTML = "【確認用】" + os + " : " + orientation + " : " + Math.round(degrees) + " : " + Math.round(degrees + orientation);
      }

      function compassHeading(alpha) {
          var degtorad = Math.PI / 180;

          var _z = alpha ? alpha * degtorad : 0;

          var cZ = Math.cos(_z);
          var sZ = Math.sin(_z);

          var compassHeading = Math.atan(-sZ / cZ);

          if (cZ < 0) {
              compassHeading += Math.PI;
          } else if (-sZ < 0) {
              compassHeading += 2 * Math.PI;
          }
          return compassHeading * (180 / Math.PI);
      }

      function detectOSSimply() {
          let ret;
          if (
              /(iPad|iPhone|iPod)/.test(navigator.platform) ||
              (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1)
          ) {
              ret = "iphone";
          } else if (navigator.userAgent.indexOf("Android") > 0) {
              ret = "android";
          } else {
              ret = "pc";
          }
          return ret;
      }

      function permitDeviceOrientationForSafari() {
          DeviceOrientationEvent.requestPermission()
              .then(response => {
                  if (response === "granted") {
                      window.addEventListener(
                          "deviceorientation",
                          detectDirection
                      );
                  }
              })
              .catch(error => {
                  console.error(error);
              });
      }

      init();
  
    </script>

    <script>
      $(window).on('load orientationchange resize', function(){
        if (window.matchMedia("(min-width: 768px)").matches || Math.abs(window.orientation) === 90) {
          $('#rotateMessage').hide();
          $('#contentWrapper').show();
        } else {
          $('#rotateMessage').show();
          $('#contentWrapper').hide();
        }
      });
    </script>
  </body>
</html>